<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package Name="7-Zip Context Menu"
           Manufacturer="7ZipContext"
           Version="1.0.0.0"
           UpgradeCode="A1B2C3D4-0000-4B3A-9E1F-000000000001"
           Scope="perMachine"
           Language="2052"
           Codepage="936"
           Compressed="yes">

    <SummaryInformation Description="7-Zip Context Menu Extension for Windows 11" />

    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />

    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- Installation directory -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="7ZipContext">
        <Directory Id="AssetsFolder" Name="Assets" />
      </Directory>
    </StandardDirectory>

    <!-- Components placed under explicit directories -->
    <DirectoryRef Id="INSTALLFOLDER">

      <!-- Main DLL -->
      <Component Id="MainDLL" Guid="A1B2C3D4-1111-4B3A-9E1F-000000000002" Bitness="always64">
        <File Id="SevenZipContextDLL" Name="7ZipContext.dll" Source="$(var.StagingDir)\7ZipContext.dll" KeyPath="yes" />
      </Component>

      <!-- AppxManifest.xml -->
      <Component Id="AppxManifest" Guid="A1B2C3D4-2222-4B3A-9E1F-000000000003" Bitness="always64">
        <File Id="AppxManifestXML" Source="$(var.StagingDir)\AppxManifest.xml" KeyPath="yes" />
      </Component>

      <!-- dummy.exe for sparse package -->
      <Component Id="DummyExe" Guid="A1B2C3D4-3333-4B3A-9E1F-000000000004" Bitness="always64">
        <File Id="DummyEXE" Source="$(var.StagingDir)\dummy.exe" KeyPath="yes" />
      </Component>

      <!-- Register script -->
      <Component Id="RegisterScript" Guid="A1B2C3D4-4444-4B3A-9E1F-000000000005" Bitness="always64">
        <File Id="RegisterPS1" Source="$(var.StagingDir)\register.ps1" KeyPath="yes" />
      </Component>

      <!-- Unregister script -->
      <Component Id="UnregisterScript" Guid="A1B2C3D4-5555-4B3A-9E1F-000000000006" Bitness="always64">
        <File Id="UnregisterPS1" Source="$(var.StagingDir)\unregister.ps1" KeyPath="yes" />
      </Component>

    </DirectoryRef>

    <!-- Assets -->
    <DirectoryRef Id="AssetsFolder">
      <Component Id="IconPNG" Guid="A1B2C3D4-6666-4B3A-9E1F-000000000007" Bitness="always64">
        <File Id="IconFile" Source="$(var.StagingDir)\Assets\icon.png" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Component groups -->
    <ComponentGroup Id="ProductComponents">
      <ComponentRef Id="MainDLL" />
      <ComponentRef Id="AppxManifest" />
      <ComponentRef Id="DummyExe" />
      <ComponentRef Id="RegisterScript" />
      <ComponentRef Id="UnregisterScript" />
    </ComponentGroup>

    <ComponentGroup Id="AssetsComponents">
      <ComponentRef Id="IconPNG" />
    </ComponentGroup>

    <!-- Custom Actions for registration -->
    <CustomAction Id="SetRegisterCmd" Property="RegisterSparsePackage"
                  Value="&quot;powershell.exe&quot; -ExecutionPolicy Bypass -NoProfile -File &quot;[INSTALLFOLDER]register.ps1&quot; &quot;[INSTALLFOLDER].&quot;" />

    <CustomAction Id="RegisterSparsePackage"
                  DllEntry="WixQuietExec64"
                  BinaryRef="Wix4UtilCA_X64"
                  Execute="deferred"
                  Impersonate="yes"
                  Return="check" />

    <CustomAction Id="SetUnregisterCmd" Property="UnregisterSparsePackage"
                  Value="&quot;powershell.exe&quot; -ExecutionPolicy Bypass -NoProfile -File &quot;[INSTALLFOLDER]unregister.ps1&quot;" />

    <CustomAction Id="UnregisterSparsePackage"
                  DllEntry="WixQuietExec64"
                  BinaryRef="Wix4UtilCA_X64"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <CustomAction Id="SetRestartExplorerInstall" Property="RestartExplorerInstall"
                  Value="&quot;powershell.exe&quot; -Command &quot;Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue; Start-Sleep 1; Start-Process explorer&quot;" />

    <CustomAction Id="RestartExplorerInstall"
                  DllEntry="WixQuietExec64"
                  BinaryRef="Wix4UtilCA_X64"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <CustomAction Id="SetRestartExplorerUninstall" Property="RestartExplorerUninstall"
                  Value="&quot;powershell.exe&quot; -Command &quot;Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue; Start-Sleep 1; Start-Process explorer&quot;" />

    <CustomAction Id="RestartExplorerUninstall"
                  DllEntry="WixQuietExec64"
                  BinaryRef="Wix4UtilCA_X64"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <InstallExecuteSequence>
      <Custom Action="SetUnregisterCmd" Before="UnregisterSparsePackage" Condition="REMOVE=&quot;ALL&quot;" />
      <Custom Action="UnregisterSparsePackage" Before="RemoveFiles" Condition="REMOVE=&quot;ALL&quot;" />
      <Custom Action="SetRestartExplorerUninstall" Before="RestartExplorerUninstall" Condition="REMOVE=&quot;ALL&quot;" />
      <Custom Action="RestartExplorerUninstall" After="UnregisterSparsePackage" Condition="REMOVE=&quot;ALL&quot;" />
      <Custom Action="SetRegisterCmd" Before="RegisterSparsePackage" Condition="NOT REMOVE" />
      <Custom Action="RegisterSparsePackage" After="InstallFiles" Condition="NOT REMOVE" />
      <Custom Action="SetRestartExplorerInstall" Before="RestartExplorerInstall" Condition="NOT REMOVE" />
      <Custom Action="RestartExplorerInstall" After="RegisterSparsePackage" Condition="NOT REMOVE" />
    </InstallExecuteSequence>

    <!-- Feature -->
    <Feature Id="ProductFeature" Title="7-Zip Context Menu" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="AssetsComponents" />
    </Feature>

    <!-- UI -->
    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="$(var.InstallerDir)\license.rtf" />

  </Package>
</Wix>
