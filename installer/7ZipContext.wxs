<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package Name="7-Zip Context Menu"
           Manufacturer="7ZipContext"
           Version="1.0.0.0"
           UpgradeCode="B8A0B7C1-7C5D-4B3A-9E1F-000000000001"
           Scope="perMachine"
           Language="2052"
           Compressed="yes">

    <SummaryInformation Description="7-Zip 右键菜单扩展 for Windows 11" />

    <MajorUpgrade DowngradeErrorMessage="已安装更新版本，无法降级安装。" />

    <MediaTemplate EmbedCab="yes" CompressionLevel="high" />

    <!-- Installation directory -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="7ZipContext">
        <Directory Id="AssetsFolder" Name="Assets" />
      </Directory>
    </StandardDirectory>

    <!-- Main component group -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">

      <!-- Main DLL -->
      <Component Id="MainDLL" Guid="B8A0B7C1-7C5D-4B3A-9E1F-000000000002" Bitness="always64">
        <File Id="7ZipContextDLL" Source="$(BuildDir)\7ZipContext.dll" KeyPath="yes" />
      </Component>

      <!-- AppxManifest.xml -->
      <Component Id="AppxManifest" Guid="B8A0B7C1-7C5D-4B3A-9E1F-000000000003" Bitness="always64">
        <File Id="AppxManifestXML" Source="$(SourceDir)\Package\AppxManifest.xml" KeyPath="yes" />
      </Component>

      <!-- dummy.exe for sparse package -->
      <Component Id="DummyExe" Guid="B8A0B7C1-7C5D-4B3A-9E1F-000000000004" Bitness="always64">
        <File Id="DummyEXE" Source="$(SourceDir)\installer\dummy.exe" KeyPath="yes" />
      </Component>

      <!-- Register script -->
      <Component Id="RegisterScript" Guid="B8A0B7C1-7C5D-4B3A-9E1F-000000000005" Bitness="always64">
        <File Id="RegisterPS1" Source="$(SourceDir)\installer\register.ps1" KeyPath="yes" />
      </Component>

      <!-- Unregister script -->
      <Component Id="UnregisterScript" Guid="B8A0B7C1-7C5D-4B3A-9E1F-000000000006" Bitness="always64">
        <File Id="UnregisterPS1" Source="$(SourceDir)\installer\unregister.ps1" KeyPath="yes" />
      </Component>

    </ComponentGroup>

    <!-- Assets -->
    <ComponentGroup Id="AssetsComponents" Directory="AssetsFolder">
      <Component Id="IconPNG" Guid="B8A0B7C1-7C5D-4B3A-9E1F-000000000007" Bitness="always64">
        <File Id="IconFile" Source="$(SourceDir)\Package\Assets\icon.png" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Custom Actions for registration -->
    <CustomAction Id="SetRegisterCmd" Property="RegisterSparsePackage"
                  Value="&quot;powershell.exe&quot; -ExecutionPolicy Bypass -NoProfile -File &quot;[INSTALLFOLDER]register.ps1&quot; &quot;[INSTALLFOLDER].&quot;" />

    <CustomAction Id="RegisterSparsePackage"
                  DllEntry="WixQuietExec64"
                  BinaryRef="Wix4UtilCA_X64"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check" />

    <CustomAction Id="SetUnregisterCmd" Property="UnregisterSparsePackage"
                  Value="&quot;powershell.exe&quot; -ExecutionPolicy Bypass -NoProfile -File &quot;[INSTALLFOLDER]unregister.ps1&quot;" />

    <CustomAction Id="UnregisterSparsePackage"
                  DllEntry="WixQuietExec64"
                  BinaryRef="Wix4UtilCA_X64"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <CustomAction Id="SetRestartCmd" Property="RestartExplorer"
                  Value="&quot;powershell.exe&quot; -Command &quot;Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue; Start-Sleep 1; Start-Process explorer&quot;" />

    <CustomAction Id="RestartExplorer"
                  DllEntry="WixQuietExec64"
                  BinaryRef="Wix4UtilCA_X64"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <InstallExecuteSequence>
      <Custom Action="SetUnregisterCmd" Before="UnregisterSparsePackage" Condition="REMOVE=&quot;ALL&quot;" />
      <Custom Action="UnregisterSparsePackage" Before="RemoveFiles" Condition="REMOVE=&quot;ALL&quot;" />
      <Custom Action="SetRegisterCmd" Before="RegisterSparsePackage" Condition="NOT REMOVE" />
      <Custom Action="RegisterSparsePackage" After="InstallFiles" Condition="NOT REMOVE" />
      <Custom Action="SetRestartCmd" Before="RestartExplorer" />
      <Custom Action="RestartExplorer" After="RegisterSparsePackage" Condition="NOT REMOVE" />
      <Custom Action="RestartExplorer" After="UnregisterSparsePackage" Condition="REMOVE=&quot;ALL&quot;" />
    </InstallExecuteSequence>

    <!-- Feature -->
    <Feature Id="ProductFeature" Title="7-Zip Context Menu" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="AssetsComponents" />
    </Feature>

    <!-- UI -->
    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="$(SourceDir)\installer\license.rtf" />

  </Package>
</Wix>
